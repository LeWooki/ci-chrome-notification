<html>
<head>
    <script src='jquery-1.5.1.min.js'></script>
 	<script src='jquery-ui-1.8.11.custom.min.js'></script>
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.11.custom.css" rel="Stylesheet" />	
	
    <script type="text/javascript">
      var req;
      var jobs =[];
      var data;
	

      function save_options() {
        localStorage.timeToRefresh =$('#timeToRefresh').val(); 
        localStorage.urlCI = $('#urlCI').val();
        findAllJobs();
      }

	//nettoyage du noms des onglets pour que celui ci puisse etre utilise comme  id d element html
	function cleanJobNameForId(viewID){
		viewID =  viewID.replace(/[^a-zA-Z0-9]+/g,'');
		return viewID;
	}
        
	  function findAllViews(){
		 $.getJSON(localStorage["urlCI"]+'/api/json', function(data) {
			$.each(data.views, function(key, val) {
				var cleanViewID = cleanJobNameForId(val.name);
				$("#tabs ul").append("<li><a href=#"+cleanViewID+">"+cleanViewID+"</a></li>");
				findAllJobsByViewId(val.name);
			 });
			$('#tabs').tabs();	
		  });	
	  }
	
	
	 function findAllJobsByViewId(viewID){
		$.getJSON(localStorage["urlCI"]+'/view/'+viewID+"/api/json/", function(data) {
			console.log("viewId clean : "+cleanJobNameForId(viewID));
		 	var cleanViewID=cleanJobNameForId(viewID);	
			$("#tabs").append("<div id="+cleanViewID+">"+cleanViewID+"</div>");
		 	//$.each(data.jobs, function(key, val) {
				//	$("#"+cleanViewID).append(val.name+"<br/>");
		 	//});  
		 });
	 }	

      function findAllJobs(){
	      $.ajaxSetup({"error":function(data) {  
            if (data.readyState==4){
					$("#dialog-modal").text('Error 404, URLincorrect');
					$( "#dialog-modal" ).dialog({
						height: 140,
						modal: true
					});
			
            }else{
              $("#dialog-modal").text();
            }
        }});
	
        var items = [];
         $.getJSON(localStorage["urlCI"]+'/api/json?tree=jobs[name]', function(data) {
              localStorage['jobs']=JSON.stringify(data.jobs);
              $.each(data.jobs, function(key, val) {
				

	
                if (localStorage.getItem(val.name)){
                  items.push('<span>'+val.name +' : <input class="jobs" id='+ val.name + ' checked=checked type="checkbox" onclick="updateListBuildToNotificate()"/></span><br/>');
                }else{
                  items.push('<span>'+val.name +' : <input class="jobs" id='+ val.name + '  type="checkbox" onclick="updateListBuildToNotificate()"/></span><br/>');
                }
                jobs.push(val.name);
              });
             
               $('<div/>', {
               html: items.join('')
                }).appendTo('body');
          });
          
          
      }


      

		function updateListBuildToNotificate(){
			$(".jobs").each(function(key, val){ 
				if($(this).is(':checked'))
				{
				 localStorage[val.id]=true;
				}else{
				    localStorage.removeItem(val.id);
				}
			});
		}
      
     
      
      $(document).ready(function() {
          $('#timeToRefresh').val(localStorage['timeToRefresh']);
          $('#urlCI').val(localStorage['urlCI']);
		  findAllViews();
          //findAllJobs();

		

      });
   
        
        
</script>
<style type="text/css" media="screen">
	.red{
		background-color: red;
	}
	.yellow{
		background-color: yellow;
	}
	.blue{
		background-color: blue;
	}
	.disabled{
  background-color: grey;
  }
  body {
	font-family: "Arial", "Helvetica", "Verdana", "sans-serif";
	font-size: 10px;
  }
</style>


</head>
<body>
 
  <h1>C.I. Monitor</h1>
  <h2>Options</h2> 
  <fieldset> 
	<legend>Basic Setup</legend> 
    <label for="urlCI">CI URL: </label>
    <input id="urlCI" name="urlCI" /><span id="error"></span><br/>
    <label for="timeToRefresh">Refresh time (ms) : </label>
    
    <input id="timeToRefresh"/>
    <button onclick="save_options()">Save</button>
    </fieldset> 
    
    <h2>Tick the boxes to monitor builds bellow : </h2>
	<div id="tabs">
		<ul/>
	</div>
	<div id="dialog-modal" title="Error"/>
   
</body>
</html>